{% extends "base.html" %}

{% block title %}Wallets - PME-X{% endblock %}

{% block header %}Wallet Management{% endblock %}

{% block content %}
<!-- Wallet Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Total Wallets</h6>
                        <h3 class="mb-0">{{ wallets|length }}</h3>
                    </div>
                    <i class="fas fa-wallet fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Total Balance</h6>
                        <h3 class="mb-0">${{ wallets|sum(attribute='usd_balance')|round(2) }}</h3>
                    </div>
                    <i class="fas fa-dollar-sign fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Active Wallets</h6>
                        <h3 class="mb-0">{{ wallets|selectattr('is_active', 'equalto', True)|list|length }}</h3>
                    </div>
                    <i class="fas fa-check-circle fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Unique Chains</h6>
                        <h3 class="mb-0">{{ wallets|map(attribute='chain')|unique|list|length }}</h3>
                    </div>
                    <i class="fas fa-link fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Wallet Actions -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addWalletModal">
                            <i class="fas fa-plus me-2"></i> Add Wallet
                        </button>
                        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#importWalletModal">
                            <i class="fas fa-file-import me-2"></i> Import Wallet
                        </button>
                        <button class="btn btn-info me-2" id="refreshBalancesBtn">
                            <i class="fas fa-sync-alt me-2"></i> Refresh Balances
                        </button>
                    </div>
                    <div class="d-flex">
                        <div class="input-group">
                            <span class="input-group-text">Chain</span>
                            <select class="form-select" id="chainFilter">
                                <option value="all">All Chains</option>
                                {% for chain in chains %}
                                <option value="{{ chain.name }}">{{ chain.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="input-group ms-2">
                            <input type="text" class="form-control" placeholder="Search..." id="walletSearch">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Wallet List -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Wallet List</h5>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary active" id="viewGrid">
                <i class="fas fa-th"></i>
            </button>
            <button class="btn btn-sm btn-outline-primary" id="viewList">
                <i class="fas fa-list"></i>
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Grid View -->
        <div class="row g-3" id="walletsGrid">
            {% for wallet in wallets %}
            <div class="col-md-4 wallet-item" data-chain="{{ wallet.chain }}">
                <div class="card h-100 {% if wallet.is_active %}border-success{% else %}border-secondary{% endif %}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <img src="{{ url_for('static', filename='img/chains/' ~ wallet.chain ~ '.png') }}" 
                                onerror="this.src='{{ url_for('static', filename='img/chains/default.jpeg') }}';"
                                     alt="{{ wallet.name }}" class="me-2" width="24" height="24" />
                            <h6 class="mb-0">{{ wallet.chain }}</h6>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input wallet-active-toggle" type="checkbox" 
                                  data-wallet-id="{{ wallet.id }}" 
                                  {% if wallet.is_active %}checked{% endif %}>
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="text-truncate">
                            <i class="fas fa-wallet text-muted me-2"></i>
                            <span class="wallet-address">{{ wallet.address }}</span>
                        </h6>
                        <div class="d-flex justify-content-between mt-3">
                            <div>
                                <small class="text-muted">Native Balance</small>
                                <p class="mb-0">{{ wallet.native_balance }} {{ chain_info[wallet.chain].currency_symbol }}</p>
                            </div>
                            <div>
                                <small class="text-muted">USD Value</small>
                                <p class="mb-0">${{ wallet.usd_balance|round(2) }}</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">Last Updated</small>
                            <p class="mb-0 small">{{ wallet.last_updated.strftime('%Y-%m-%d %H:%M') }}</p>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                        <button class="btn btn-sm btn-outline-primary view-tokens-btn" data-wallet-id="{{ wallet.id }}">
                            <i class="fas fa-coins me-1"></i> Tokens
                        </button>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary edit-wallet-btn" data-wallet-id="{{ wallet.id }}" 
                                    data-address="{{ wallet.address }}" data-chain="{{ wallet.chain }}" 
                                    data-active="{{ wallet.is_active|lower }}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary copy-address-btn" data-address="{{ wallet.address }}">
                                <i class="fas fa-copy"></i>
                            </button>
                            <a href="{{ chain_info[wallet.chain].explorer_url }}/address/{{ wallet.address }}" 
                               target="_blank" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-danger delete-wallet-btn" data-wallet-id="{{ wallet.id }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12 text-center py-5">
                <i class="fas fa-wallet fa-3x text-muted mb-3"></i>
                <h5>No wallets found</h5>
                <p class="text-muted">Add a wallet to get started with trading</p>
                <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addWalletModal">
                    <i class="fas fa-plus me-2"></i> Add Wallet
                </button>
            </div>
            {% endfor %}
        </div>
        
        <!-- List View (initially hidden) -->
        <div class="table-responsive" id="walletsList" style="display: none;">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Chain</th>
                        <th>Address</th>
                        <th>Native Balance</th>
                        <th>USD Value</th>
                        <th>Status</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for wallet in wallets %}
                    <tr class="wallet-item" data-chain="{{ wallet.chain }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="{{ url_for('static', filename='img/chains/' ~ wallet.chain ~ '.png') }}" 
                                     onerror="this.src='{{ url_for('static', filename='img/chains/default.jpeg') }}';"
                                     alt="{{ wallet.chain }}" class="me-2" width="24" height="24" />
                                <span>{{ wallet.chain }}</span>
                            </div>
                        </td>
                        <td class="text-truncate" style="max-width: 150px;">{{ wallet.address }}</td>
                        <td>{{ wallet.native_balance }} {{ chain_info[wallet.chain].currency_symbol }}</td>
                        <td>${{ wallet.usd_balance|round(2) }}</td>
                        <td>
                            {% if wallet.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>{{ wallet.last_updated.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary view-tokens-btn" data-wallet-id="{{ wallet.id }}">
                                    <i class="fas fa-coins"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary edit-wallet-btn" data-wallet-id="{{ wallet.id }}" 
                                        data-address="{{ wallet.address }}" data-chain="{{ wallet.chain }}" 
                                        data-active="{{ wallet.is_active|lower }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary copy-address-btn" data-address="{{ wallet.address }}">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <a href="{{ chain_info[wallet.chain].explorer_url }}/address/{{ wallet.address }}" 
                                   target="_blank" class="btn btn-sm btn-outline-info">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger delete-wallet-btn" data-wallet-id="{{ wallet.id }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-wallet fa-2x text-muted mb-3"></i>
                            <h5>No wallets found</h5>
                            <p class="text-muted">Add a wallet to get started with trading</p>
                            <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addWalletModal">
                                <i class="fas fa-plus me-2"></i> Add Wallet
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Wallet Multi-Select Panel -->
<div class="card mt-4 mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Execute Multiple Strategies</h5>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary" id="selectAllWallets">
                <i class="fas fa-check-square me-1"></i> Select All
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="deselectAllWallets">
                <i class="fas fa-square me-1"></i> Deselect All
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="wallet-selection-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6>Select Wallets for Strategy Execution</h6>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="activeWalletsOnly" checked>
                    <label class="form-check-label" for="activeWalletsOnly">Active Wallets Only</label>
                </div>
            </div>
            
            <div class="row g-3 wallet-selection-grid">
                <!-- Iterate through wallets and render selection checkboxes -->
                {% for wallet in wallets %}
                <div class="col-md-6 col-lg-4 wallet-selection-item" 
                     data-active="{{ wallet.is_active|lower }}" 
                     data-chain="{{ wallet.chain }}">
                    <div class="card h-100 {% if wallet.is_active %}border-success{% else %}border-secondary{% endif %}">
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input wallet-selector" 
                                       type="checkbox" 
                                       value="{{ wallet.id }}" 
                                       id="wallet-selector-{{ wallet.id }}"
                                       {% if not wallet.is_active %}disabled{% endif %}>
                                <label class="form-check-label d-flex justify-content-between align-items-center" 
                                       for="wallet-selector-{{ wallet.id }}">
                                    <div>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ url_for('static', filename='img/chains/' ~ wallet.chain ~ '.png') }}" 
                                                onerror="this.src='{{ url_for('static', filename='img/chains/default.jpeg') }}';"
                                                class="me-2" width="16" height="16" />
                                            <span>{{ wallet.address[:8] }}...{{ wallet.address[-6:] }}</span>
                                        </div>
                                        <small class="text-muted">{{ wallet.chain }}</small>
                                    </div>
                                    <div class="text-end">
                                        <div>{{ wallet.native_balance|round(4) }} {{ chain_info[wallet.chain].currency_symbol }}</div>
                                        <small class="text-muted">${{ wallet.usd_balance|round(2) }}</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="mt-4 text-center">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#executeWalletStrategiesModal" id="executeWalletStrategiesBtnPre">
                    <i class="fas fa-rocket me-2"></i> Execute Strategies
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Execute Strategies Modal -->
<div class="modal fade" id="executeWalletStrategiesModal" tabindex="-1" aria-labelledby="executeWalletStrategiesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="executeWalletStrategiesModalLabel">Execute Strategies</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Strategy selection -->
                <div class="mb-4">
                    <h6>Select Strategies</h6>
                    <div class="strategy-selection">
                        <div class="form-check mb-2">
                            <input class="form-check-input strategy-checkbox" type="checkbox" 
                                   value="flash_loan" id="strategy-flash-loan">
                            <label class="form-check-label" for="strategy-flash-loan">
                                <i class="fas fa-bolt me-1"></i> Flash Loan Arbitrage
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input strategy-checkbox" type="checkbox" 
                                   value="multi_hop" id="strategy-multi-hop">
                            <label class="form-check-label" for="strategy-multi-hop">
                                <i class="fas fa-route me-1"></i> Multi-Hop Arbitrage
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input strategy-checkbox" type="checkbox" 
                                   value="cross_chain" id="strategy-cross-chain">
                            <label class="form-check-label" for="strategy-cross-chain">
                                <i class="fas fa-exchange-alt me-1"></i> Cross-Chain Arbitrage
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input strategy-checkbox" type="checkbox" 
                                   value="yield_farming" id="strategy-yield-farming">
                            <label class="form-check-label" for="strategy-yield-farming">
                                <i class="fas fa-seedling me-1"></i> Yield Farming
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Execution configuration -->
                <div class="mb-4">
                    <h6>Execution Configuration</h6>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="executionMode" id="parallelExecution" value="parallel" checked>
                        <label class="form-check-label" for="parallelExecution">
                            <i class="fas fa-random me-1"></i> Parallel Execution (Faster)
                            <small class="text-muted d-block">Executes all strategies simultaneously for maximum efficiency</small>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="executionMode" id="sequentialExecution" value="sequential">
                        <label class="form-check-label" for="sequentialExecution">
                            <i class="fas fa-stream me-1"></i> Sequential Execution (Safer)
                            <small class="text-muted d-block">Executes strategies one by one to reduce risk</small>
                        </label>
                    </div>
                </div>
                
                <!-- Summary display -->
                <div class="alert alert-info">
                    <div class="d-flex justify-content-between">
                        <span><strong>Selected Wallets:</strong> <span id="selectedWalletsCount">0</span></span>
                        <span><strong>Selected Strategies:</strong> <span id="selectedStrategiesCount">0</span></span>
                    </div>
                </div>
                
                <!-- Strategy parameters -->
                <div id="strategyParamsContainer">
                    <!-- Dynamic strategy parameter inputs will be inserted here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="executeWalletStrategiesBtn">
                    <i class="fas fa-rocket me-1"></i> Execute
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Execution Progress Modal -->
<div class="modal fade" id="executionProgressModal" tabindex="-1" aria-labelledby="executionProgressModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="executionProgressModalLabel">Execution Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="progress mb-4">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                
                <div class="execution-logs mb-4">
                    <h6>Execution Logs</h6>
                    <div id="executionLogContainer" class="border p-3 bg-light" style="height: 200px; overflow-y: auto; font-family: monospace;">
                        <!-- Logs will be appended here -->
                    </div>
                </div>
                
                <div class="execution-summary">
                    <h6>Execution Summary</h6>
                    <div id="executionSummaryContainer">
                        <!-- Summary will be displayed here -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Executing strategies...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelExecutionBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="completeExecutionBtn" disabled data-bs-dismiss="modal">Complete</button>
            </div>
        </div>
    </div>
</div><!-- Edit Wallet Modal -->
<div class="modal fade" id="editWalletModal" tabindex="-1" aria-labelledby="editWalletModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editWalletModalLabel">Edit Wallet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="edit-wallet-form" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                    <input type="hidden" name="wallet_id" id="edit-wallet-id">
                    
                    <div class="mb-3">
                        <label class="form-label">Wallet Address</label>
                        <input type="text" class="form-control" id="edit-wallet-address" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Chain</label>
                        <input type="text" class="form-control" id="edit-wallet-chain" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Private Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="edit-wallet-private-key" name="private_key"
                                   placeholder="Enter private key to enable trading">
                            <button class="btn btn-outline-secondary toggle-password" type="button">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Enter a valid 64-character hexadecimal private key (can include 0x prefix)
                        </div>
                        <div class="form-text text-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            Private key is required for trading operations and is stored securely
                        </div>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="edit-wallet-active" name="is_active">
                        <label class="form-check-label" for="edit-wallet-active">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="save-wallet-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Add Wallet Modal -->
<div class="modal fade" id="addWalletModal" tabindex="-1" aria-labelledby="addWalletModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addWalletModalLabel">Add New Wallet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="add-wallet-form" method="POST" action="{{ url_for('api.add_wallet') }}">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                    <input type="hidden" name="action" value="add">
                    
                    <div class="mb-3">
                        <label class="form-label">Creation Method</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="wallet-method" id="method-new" autocomplete="off" checked>
                            <label class="btn btn-outline-primary" for="method-new">Create New</label>
                            
                            <input type="radio" class="btn-check" name="wallet-method" id="method-existing" autocomplete="off">
                            <label class="btn btn-outline-primary" for="method-existing">Use Existing</label>
                        </div>
                    </div>
                    
                    <div id="new-wallet-fields">
                        <div class="mb-3">
                            <label class="form-label">Select Chain</label>
                            <select class="form-select" id="add-chain" name="chain" required>
                                <option value="" selected disabled>Choose a chain...</option>
                                {% for chain in chains %}
                                {% if chain.status == 'active' %}
                                <option value="{{ chain.name }}">{{ chain.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            A new wallet will be generated for the selected chain.
                        </div>
                    </div>
                    
                    <div id="existing-wallet-fields" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Select Chain</label>
                            <select class="form-select" id="existing-chain" name="existing-chain" required>
                                <option value="" selected disabled>Choose a chain...</option>
                                {% for chain in chains %}
                                {% if chain.status == 'active' %}
                                <option value="{{ chain.name }}">{{ chain.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Wallet Address</label>
                            <input type="text" class="form-control" id="existing-address" name="address"
                                   placeholder="0x..." required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Private Key (Optional)</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="existing-private-key" name="private-key"
                                       placeholder="Enter private key to enable trading">
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">Private key is required for trading operations</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="add-wallet-btn">Add Wallet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import Wallet Modal -->
<div class="modal fade" id="importWalletModal" tabindex="-1" aria-labelledby="importWalletModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importWalletModalLabel">Import Wallet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="import-wallet-form" method="POST" action="{{ url_for('api.import_wallet') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                    
                    <div class="mb-3">
                        <label class="form-label">Import Method</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="import-method" id="method-keystore" autocomplete="off" checked>
                            <label class="btn btn-outline-primary" for="method-keystore">Keystore</label>
                            
                            <input type="radio" class="btn-check" name="import-method" id="method-mnemonic" autocomplete="off">
                            <label class="btn btn-outline-primary" for="method-mnemonic">Mnemonic</label>
                            
                            <input type="radio" class="btn-check" name="import-method" id="method-private-key" autocomplete="off">
                            <label class="btn btn-outline-primary" for="method-private-key">Private Key</label>
                        </div>
                    </div>
                    
                    <div id="keystore-fields">
                        <div class="mb-3">
                            <label class="form-label">Keystore File</label>
                            <input type="file" class="form-control" id="keystore-file" name="keystore_file" accept=".json">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="keystore-password" name="keystore_password" placeholder="Enter keystore password">
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="mnemonic-fields" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Mnemonic Phrase</label>
                            <textarea class="form-control" id="mnemonic-phrase" name="mnemonic_phrase" rows="3" 
                                      placeholder="Enter 12 or 24 word mnemonic phrase"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Derivation Path (Optional)</label>
                            <input type="text" class="form-control" id="derivation-path" name="derivation_path"
                                   placeholder="m/44'/60'/0'/0/0" value="m/44'/60'/0'/0/0">
                        </div>
                    </div>
                    
                    <div id="private-key-fields" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Private Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="import-private-key" name="private_key" placeholder="Enter private key">
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Select Chains</label>
                        <select class="form-select" id="import-chains" name="import_chains" multiple size="5">
                            {% for chain in chains %}
                            {% if chain.status == 'active' %}
                            <option value="{{ chain.name }}">{{ chain.name }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                        <div class="form-text">Hold Ctrl/Cmd to select multiple chains</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="import-wallet-btn">Import Wallet</button>
            </div>
        </div>
    </div>
</div>

<!-- Token Modal -->
<div class="modal fade" id="tokensModal" tabindex="-1" aria-labelledby="tokensModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tokensModalLabel">Wallet Tokens</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-3">
                    <div>
                        <h6 class="mb-0">Wallet: <span id="token-wallet-address" class="text-truncate"></span></h6>
                        <small class="text-muted">Chain: <span id="token-wallet-chain"></span></small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" id="refresh-tokens-btn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table" id="tokens-table">
                        <thead>
                            <tr>
                                <th>Token</th>
                                <th>Balance</th>
                                <th>USD Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tokens-list">
                            <!-- Token rows will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirm-modal-content">
                Are you sure you want to proceed with this action?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-action-btn">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/wallet_strategies.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle between grid and list view
    const viewGridBtn = document.getElementById('viewGrid');
    const viewListBtn = document.getElementById('viewList');
    const walletsGrid = document.getElementById('walletsGrid');
    const walletsList = document.getElementById('walletsList');
    
    viewGridBtn.addEventListener('click', function() {
        walletsGrid.style.display = 'flex';
        walletsList.style.display = 'none';
        viewGridBtn.classList.add('active');
        viewListBtn.classList.remove('active');
    });
    
    viewListBtn.addEventListener('click', function() {
        walletsGrid.style.display = 'none';
        walletsList.style.display = 'block';
        viewGridBtn.classList.remove('active');
        viewListBtn.classList.add('active');
    });
    
    // Copy address to clipboard
    const copyButtons = document.querySelectorAll('.copy-address-btn');
    copyButtons.forEach(button => {
        button.addEventListener('click', function() {
            const address = this.getAttribute('data-address');
            navigator.clipboard.writeText(address)
                .then(() => {
                    // Show tooltip
                    this.setAttribute('data-original-title', 'Copied!');
                    this.setAttribute('title', 'Copied!');
                    
                    // Change icon temporarily
                    const icon = this.querySelector('i');
                    icon.classList.remove('fa-copy');
                    icon.classList.add('fa-check');
                    
                    // Reset after 2 seconds
                    setTimeout(() => {
                        icon.classList.remove('fa-check');
                        icon.classList.add('fa-copy');
                        this.setAttribute('title', 'Copy Address');
                    }, 2000);
                })
                .catch(err => {
                    console.error('Could not copy text: ', err);
                });
        });
    });
    
    // Filter wallets by chain
    const chainFilter = document.getElementById('chainFilter');
    chainFilter.addEventListener('change', function() {
        const selectedChain = this.value;
        const walletItems = document.querySelectorAll('.wallet-item');
        
        walletItems.forEach(item => {
            if (selectedChain === 'all' || item.getAttribute('data-chain') === selectedChain) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // Search wallets
    const walletSearch = document.getElementById('walletSearch');
    walletSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const walletItems = document.querySelectorAll('.wallet-item');
        
        walletItems.forEach(item => {
            const address = item.querySelector('.wallet-address')?.textContent.toLowerCase() || '';
            const chain = item.getAttribute('data-chain').toLowerCase();
            
            if (address.includes(searchTerm) || chain.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // Toggle wallet active state
    const toggleSwitches = document.querySelectorAll('.wallet-active-toggle');
    toggleSwitches.forEach(toggle => {
        toggle.addEventListener('change', function() {
            const walletId = this.getAttribute('data-wallet-id');
            const isActive = this.checked;
            
            // Make API call to update wallet status
            fetch('/api/wallet/toggle_active', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': '{{ csrf_token() if csrf_token else "" }}'
                },
                body: JSON.stringify({
                    wallet_id: walletId,
                    is_active: isActive
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update card border
                    const card = this.closest('.card');
                    if (isActive) {
                        card.classList.remove('border-secondary');
                        card.classList.add('border-success');
                    } else {
                        card.classList.remove('border-success');
                        card.classList.add('border-secondary');
                    }
                    
                    // Update list view status badge
                    const walletRow = document.querySelector(`tr.wallet-item[data-wallet-id="${walletId}"]`);
                    if (walletRow) {
                        const statusBadge = walletRow.querySelector('td:nth-child(5) .badge');
                        if (isActive) {
                            statusBadge.classList.remove('bg-secondary');
                            statusBadge.classList.add('bg-success');
                            statusBadge.textContent = 'Active';
                        } else {
                            statusBadge.classList.remove('bg-success');
                            statusBadge.classList.add('bg-secondary');
                            statusBadge.textContent = 'Inactive';
                        }
                    }
                } else {
                    // Revert toggle if API call failed
                    this.checked = !isActive;
                    alert('Failed to update wallet status: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Revert toggle if API call failed
                this.checked = !isActive;
                alert('An error occurred while updating wallet status');
            });
        });
    });
    
    // Add wallet modal logic
    const methodNewRadio = document.getElementById('method-new');
    const methodExistingRadio = document.getElementById('method-existing');
    const newWalletFields = document.getElementById('new-wallet-fields');
    const existingWalletFields = document.getElementById('existing-wallet-fields');
    
    methodNewRadio.addEventListener('change', function() {
        if (this.checked) {
            newWalletFields.style.display = 'block';
            existingWalletFields.style.display = 'none';
        }
    });
    
    methodExistingRadio.addEventListener('change', function() {
        if (this.checked) {
            newWalletFields.style.display = 'none';
            existingWalletFields.style.display = 'block';
        }
    });
    
    // Import wallet modal logic
    const methodKeystoreRadio = document.getElementById('method-keystore');
    const methodMnemonicRadio = document.getElementById('method-mnemonic');
    const methodPrivateKeyRadio = document.getElementById('method-private-key');
    const keystoreFields = document.getElementById('keystore-fields');
    const mnemonicFields = document.getElementById('mnemonic-fields');
    const privateKeyFields = document.getElementById('private-key-fields');
    
    methodKeystoreRadio.addEventListener('change', function() {
        if (this.checked) {
            keystoreFields.style.display = 'block';
            mnemonicFields.style.display = 'none';
            privateKeyFields.style.display = 'none';
        }
    });
    
    methodMnemonicRadio.addEventListener('change', function() {
        if (this.checked) {
            keystoreFields.style.display = 'none';
            mnemonicFields.style.display = 'block';
            privateKeyFields.style.display = 'none';
        }
    });
    
    methodPrivateKeyRadio.addEventListener('change', function() {
        if (this.checked) {
            keystoreFields.style.display = 'none';
            mnemonicFields.style.display = 'none';
            privateKeyFields.style.display = 'block';
        }
    });
    
    // Toggle password visibility
    const togglePasswordButtons = document.querySelectorAll('.toggle-password');
    togglePasswordButtons.forEach(button => {
        button.addEventListener('click', function() {
            const passwordInput = this.previousElementSibling;
            const icon = this.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
    });
    
    // View tokens functionality
    const viewTokensButtons = document.querySelectorAll('.view-tokens-btn');
    const tokensModal = new bootstrap.Modal(document.getElementById('tokensModal'));
    
    viewTokensButtons.forEach(button => {
        button.addEventListener('click', function() {
            const walletId = this.getAttribute('data-wallet-id');
            const walletItem = this.closest('.wallet-item');
            const walletAddress = walletItem.querySelector('.wallet-address').textContent;
            const walletChain = walletItem.getAttribute('data-chain');
            
            document.getElementById('token-wallet-address').textContent = walletAddress;
            document.getElementById('token-wallet-chain').textContent = walletChain;
            
            // Clear previous tokens
            document.getElementById('tokens-list').innerHTML = '';
            
            // Show loading state
            document.getElementById('tokens-list').innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading tokens...</p>
                    </td>
                </tr>
            `;
            
            // Fetch tokens from API
            fetch(`/api/wallet/${walletId}/tokens`)
                .then(response => response.json())
                .then(data => {
                    const tokensList = document.getElementById('tokens-list');
                    
                    if (data.success && data.tokens && data.tokens.length > 0) {
                        tokensList.innerHTML = '';
                        
                        data.tokens.forEach(token => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="${token.logo_url || '{{ url_for('static', filename='img/chains/default.jpeg') }}'}" 
                                             onerror="this.src='{{ url_for('static', filename='img/chains/default.jpeg') }}';"
                                             alt="${token.symbol}" class="me-2" width="24" height="24" />
                                        <div>
                                            <div>${token.symbol}</div>
                                            <small class="text-muted">${token.name}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>${parseFloat(token.balance).toLocaleString(undefined, {maximumFractionDigits: 8})}</td>
                                <td>${parseFloat(token.usd_value).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-exchange-alt"></i>
                                        </button>
                                        <a href="${token.explorer_url || '#'}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-file-contract"></i>
                                        </a>
                                    </div>
                                </td>
                            `;
                            tokensList.appendChild(row);
                        });
                    } else {
                        tokensList.innerHTML = `
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <i class="fas fa-coins fa-2x text-muted mb-3"></i>
                                    <p>No tokens found in this wallet</p>
                                </td>
                            </tr>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching tokens:', error);
                    document.getElementById('tokens-list').innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-4">
                                <i class="fas fa-exclamation-circle fa-2x text-danger mb-3"></i>
                                <p>Error loading tokens. Please try again.</p>
                            </td>
                        </tr>
                    `;
                });
            
            tokensModal.show();
        });
    });
    
    // Refresh tokens button
    document.getElementById('refresh-tokens-btn').addEventListener('click', function() {
        const walletAddress = document.getElementById('token-wallet-address').textContent;
        const walletChain = document.getElementById('token-wallet-chain').textContent;
        
        // Find wallet ID from the DOM
        let walletId = null;
        document.querySelectorAll('.wallet-item').forEach(item => {
            if (item.querySelector('.wallet-address').textContent === walletAddress &&
                item.getAttribute('data-chain') === walletChain) {
                walletId = item.querySelector('.view-tokens-btn').getAttribute('data-wallet-id');
            }
        });
        
        if (!walletId) return;
        
        // Show loading state
        document.getElementById('tokens-list').innerHTML = `
            <tr>
                <td colspan="4" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Refreshing tokens...</p>
                </td>
            </tr>
        `;
        
        // Call API to refresh tokens
        fetch(`/api/wallet/${walletId}/refresh-tokens`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': '{{ csrf_token() if csrf_token else "" }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fetch updated tokens
                fetch(`/api/wallet/${walletId}/tokens`)
                    .then(response => response.json())
                    .then(data => {
                        const tokensList = document.getElementById('tokens-list');
                        
                        if (data.success && data.tokens && data.tokens.length > 0) {
                            tokensList.innerHTML = '';
                            
                            data.tokens.forEach(token => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="${token.logo_url || '{{ url_for('static', filename='img/chains/default.jpeg') }}'}" 
                                                 onerror="this.src='{{ url_for('static', filename='img/chain/default.jpeg') }}';"
                                                 alt="${token.symbol}" class="me-2" width="24" height="24" />
                                            <div>
                                                <div>${token.symbol}</div>
                                                <small class="text-muted">${token.name}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>${parseFloat(token.balance).toLocaleString(undefined, {maximumFractionDigits: 8})}</td>
                                    <td>${parseFloat(token.usd_value).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-exchange-alt"></i>
                                            </button>
                                            <a href="${token.explorer_url || '#'}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                <i class="fas fa-file-contract"></i>
                                            </a>
                                        </div>
                                    </td>
                                `;
                                tokensList.appendChild(row);
                            });
                        } else {
                            tokensList.innerHTML = `
                                <tr>
                                    <td colspan="4" class="text-center py-4">
                                        <i class="fas fa-coins fa-2x text-muted mb-3"></i>
                                        <p>No tokens found in this wallet</p>
                                    </td>
                                </tr>
                            `;
                        }
                    });
            } else {
                document.getElementById('tokens-list').innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-4">
                            <i class="fas fa-exclamation-circle fa-2x text-danger mb-3"></i>
                            <p>Error refreshing tokens: ${data.error}</p>
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error refreshing tokens:', error);
            document.getElementById('tokens-list').innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-4">
                        <i class="fas fa-exclamation-circle fa-2x text-danger mb-3"></i>
                        <p>Error refreshing tokens. Please try again.</p>
                    </td>
                </tr>
            `;
        });
    });
    
    // Delete wallet functionality
    const deleteWalletButtons = document.querySelectorAll('.delete-wallet-btn');
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    const confirmActionBtn = document.getElementById('confirm-action-btn');
    
    deleteWalletButtons.forEach(button => {
        button.addEventListener('click', function() {
            const walletId = this.getAttribute('data-wallet-id');
            const walletItem = this.closest('.wallet-item');
            const walletAddress = walletItem.querySelector('.wallet-address').textContent;
            
            document.getElementById('confirmModalLabel').textContent = 'Delete Wallet';
            document.getElementById('confirm-modal-content').innerHTML = `
                <p>Are you sure you want to delete this wallet?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    This action cannot be undone. Make sure you have backed up your private key.
                </div>
                <div class="mb-3">
                    <label class="form-label">Wallet Address</label>
                    <input type="text" class="form-control" value="${walletAddress}" readonly>
                </div>
            `;
            
            // Set up confirmation action
            confirmActionBtn.onclick = function() {
                // Delete wallet via API
                fetch(`/api/wallet/${walletId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': '{{ csrf_token() if csrf_token else "" }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove wallet from DOM
                        const gridItem = document.querySelector(`.wallet-item[data-wallet-id="${walletId}"]`);
                        if (gridItem) gridItem.remove();
                        
                        const listItem = document.querySelector(`tr.wallet-item[data-wallet-id="${walletId}"]`);
                        if (listItem) listItem.remove();
                        
                        // Update wallet counts
                        const totalWallets = document.querySelectorAll('.wallet-item').length;
                        document.querySelector('.card.bg-primary .card-body h3').textContent = totalWallets;
                        
                        // Show success notification
                        showNotification('success', 'Wallet deleted successfully.');
                    } else {
                        showNotification('danger', `Failed to delete wallet: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error deleting wallet:', error);
                    showNotification('danger', 'An error occurred while deleting the wallet.');
                })
                .finally(() => {
                    // Close modal
                    confirmModal.hide();
                });
            };
            
            confirmModal.show();
        });
    });
    // Edit wallet functionality
const editWalletButtons = document.querySelectorAll('.edit-wallet-btn');
const editWalletModal = new bootstrap.Modal(document.getElementById('editWalletModal'));

editWalletButtons.forEach(button => {
    button.addEventListener('click', function() {
        const walletId = this.getAttribute('data-wallet-id');
        const walletAddress = this.getAttribute('data-address');
        const walletChain = this.getAttribute('data-chain');
        const isActive = this.getAttribute('data-active') === 'true';
        
        // Set form values
        document.getElementById('edit-wallet-id').value = walletId;
        document.getElementById('edit-wallet-address').value = walletAddress;
        document.getElementById('edit-wallet-chain').value = walletChain;
        document.getElementById('edit-wallet-active').checked = isActive;
        
        // Clear private key field for security
        document.getElementById('edit-wallet-private-key').value = '';
        
        // Update form action
        document.getElementById('edit-wallet-form').action = '{{ url_for("api.update_wallet") }}';
        
        // Show modal
        editWalletModal.show();
    });
});

// Handle edit wallet form submission
document.getElementById('edit-wallet-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const formData = new FormData(form);
    
    // Clean up the private key input before submission
    const privateKeyInput = document.getElementById('edit-wallet-private-key');
    if (privateKeyInput.value) {
        // Extract just the last 64 characters if it's longer
        const value = privateKeyInput.value.trim();
        if (value.length > 64) {
            privateKeyInput.value = value.substring(value.length - 64);
        }
        // Trim the value to remove any whitespace
        privateKeyInput.value = privateKeyInput.value.trim();
        
        // Validate length
        let privateKey = privateKeyInput.value;
        if (privateKey.startsWith('0x')) {
            privateKey = privateKey.substring(2);
        }
        
        if (privateKey.length !== 64) {
            showNotification('warning', `Private key must be 64 hexadecimal characters (currently ${privateKey.length})`);
            return;
        }
        
        // Validate hexadecimal format
        if (!/^[0-9a-fA-F]+$/.test(privateKey)) {
            showNotification('warning', 'Private key must contain only hexadecimal characters (0-9, a-f, A-F)');
            return;
        }
    }
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            editWalletModal.hide();
            
            // Show success notification
            showNotification('success', data.message);
            
            // Update UI if needed (for active state)
            const walletId = formData.get('wallet_id');
            const isActive = formData.get('is_active') === 'on';
            
            const walletItems = document.querySelectorAll(`.wallet-item`);
            walletItems.forEach(item => {
                const walletButtons = item.querySelectorAll(`button[data-wallet-id="${walletId}"]`);
                if (walletButtons.length > 0) {
                    // Update data attribute
                    walletButtons.forEach(btn => {
                        btn.setAttribute('data-active', isActive);
                    });
                    
                    // Update card styling if applicable
                    const card = item.querySelector('.card');
                    if (card) {
                        if (isActive) {
                            card.classList.remove('border-secondary');
                            card.classList.add('border-success');
                        } else {
                            card.classList.remove('border-success');
                            card.classList.add('border-secondary');
                        }
                    }
                    
                    // Update toggle switch if applicable
                    const toggle = item.querySelector('.wallet-active-toggle');
                    if (toggle) {
                        toggle.checked = isActive;
                    }
                }
            });
        } else {
            // Show error notification
            showNotification('danger', `Failed to update wallet: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('danger', 'An error occurred while updating wallet');
    });
});
    // Add wallet functionality
    const addWalletBtn = document.getElementById('add-wallet-btn');
    addWalletBtn.addEventListener('click', function() {
        const form = document.getElementById('add-wallet-form');
        const isNewWallet = document.getElementById('method-new').checked;
        
        // Update form action based on method
        if (isNewWallet) {
            form.action = '{{ url_for("api.create_wallet") }}';
            form.querySelector('input[name="action"]').value = 'create';
        } else {
            form.action = '{{ url_for("api.add_wallet") }}';
            form.querySelector('input[name="action"]').value = 'import';
        }
        
        // Simple validation
        let isValid = true;
        
        if (isNewWallet) {
            const chain = document.getElementById('add-chain').value;
            if (!chain) {
                document.getElementById('add-chain').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('add-chain').classList.remove('is-invalid');
            }
        } else {
            const chain = document.getElementById('existing-chain').value;
            const address = document.getElementById('existing-address').value;
            
            if (!chain) {
                document.getElementById('existing-chain').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('existing-chain').classList.remove('is-invalid');
            }
            
            if (!address || !address.startsWith('0x')) {
                document.getElementById('existing-address').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('existing-address').classList.remove('is-invalid');
            }
        }
        
        if (!isValid) {
            return;
        }
        
        // Submit the form
        form.submit();
    });
    
    // Import wallet functionality
    document.getElementById('import-wallet-btn').addEventListener('click', function() {
        const form = document.getElementById('import-wallet-form');
        
        // Set import method
        const methodKeystore = document.getElementById('method-keystore').checked;
        const methodMnemonic = document.getElementById('method-mnemonic').checked;
        const methodPrivateKey = document.getElementById('method-private-key').checked;
        
        let importMethod = '';
        if (methodKeystore) importMethod = 'keystore';
        else if (methodMnemonic) importMethod = 'mnemonic';
        else if (methodPrivateKey) importMethod = 'private_key';
        
        const methodInput = document.createElement('input');
        methodInput.type = 'hidden';
        methodInput.name = 'import_method';
        methodInput.value = importMethod;
        form.appendChild(methodInput);
        
        // Submit the form
        form.submit();
    });
    
    // Refresh balances functionality
    document.getElementById('refreshBalancesBtn').addEventListener('click', function() {
        const button = this;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Refreshing...';
        button.disabled = true;
        
        // Call API to refresh all wallet balances
        fetch('/api/wallets/refresh', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': '{{ csrf_token() if csrf_token else "" }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the page to show updated balances
                window.location.reload();
            } else {
                // Reset button
                button.innerHTML = '<i class="fas fa-sync-alt me-2"></i> Refresh Balances';
                button.disabled = false;
                
                showNotification('danger', `Failed to refresh balances: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error refreshing balances:', error);
            
            // Reset button
            button.innerHTML = '<i class="fas fa-sync-alt me-2"></i> Refresh Balances';
            button.disabled = false;
            
            showNotification('danger', 'An error occurred while refreshing balances.');
        });
    });
    
    // Helper function to show notifications
    function showNotification(type, message) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
        notification.style.zIndex = '9999';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(notification);
        
        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
});
</script>
{% endblock %}
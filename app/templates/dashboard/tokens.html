{% extends "base.html" %}

{% block title %}Token Management - PME-X{% endblock %}

{% block header %}Token Discovery & Management{% endblock %}

{% block content %}
<!-- Token Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Total Tokens</h6>
                        <h3 class="mb-0">{{ tokens|length }}</h3>
                    </div>
                    <i class="fas fa-coins fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Total Value</h6>
                        <h3 class="mb-0">${{ tokens|sum(attribute='usd_value')|round(2) }}</h3>
                    </div>
                    <i class="fas fa-dollar-sign fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Token Lists</h6>
                        <h3 class="mb-0">{{ token_lists|length }}</h3>
                    </div>
                    <i class="fas fa-list fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Unique Chains</h6>
                        <h3 class="mb-0">{{ tokens|map(attribute='chain')|unique|list|length }}</h3>
                    </div>
                    <i class="fas fa-link fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Token Actions -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#scanTokensModal">
                            <i class="fas fa-search me-2"></i> Scan for Tokens
                        </button>
                        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addTokenModal">
                            <i class="fas fa-plus me-2"></i> Add Custom Token
                        </button>
                        <button class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#importTokenListModal">
                            <i class="fas fa-file-import me-2"></i> Import Token List
                        </button>
                        <button class="btn btn-secondary me-2" id="refreshTokensBtn">
                            <i class="fas fa-sync-alt me-2"></i> Refresh Balances
                        </button>
                    </div>
                    <div class="d-flex">
                        <div class="input-group">
                            <span class="input-group-text">Chain</span>
                            <select class="form-select" id="chainFilter">
                                <option value="all">All Chains</option>
                                {% for chain in chains %}
                                <option value="{{ chain.name }}">{{ chain.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="input-group ms-2">
                            <span class="input-group-text">Wallet</span>
                            <select class="form-select" id="walletFilter">
                                <option value="all">All Wallets</option>
                                {% for wallet in wallets %}
                                <option value="{{ wallet.id }}">{{ wallet.address[:10] }}...</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="input-group ms-2">
                            <input type="text" class="form-control" placeholder="Search..." id="tokenSearch">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Token List -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Token List</h5>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary active" id="viewGrid">
                <i class="fas fa-th"></i>
            </button>
            <button class="btn btn-sm btn-outline-primary" id="viewList">
                <i class="fas fa-list"></i>
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Grid View -->
        <div class="row g-3" id="tokensGrid">
            {% for token in tokens %}
            <div class="col-md-4 token-item" data-chain="{{ token.chain }}" data-wallet="{{ token.wallet_id }}">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <img src="{{ token.logo_url or url_for('static', filename='img/tokens/default.jpeg') }}" 
                                 onerror="this.src='{{ url_for('static', filename='img/tokens/default.jpeg') }}';"
                                 alt="{{ token.symbol }}" class="me-2" width="24" height="24" />
                            <h6 class="mb-0">{{ token.symbol }}</h6>
                        </div>
                        <span class="badge {% if token.price_24h_change > 0 %}bg-success{% elif token.price_24h_change < 0 %}bg-danger{% else %}bg-secondary{% endif %}">
                            {% if token.price_24h_change > 0 %}+{% endif %}{{ token.price_24h_change|round(2) }}%
                        </span>
                    </div>
                    <div class="card-body">
                        <h6 class="text-truncate">
                            <i class="fas fa-coins text-muted me-2"></i>
                            <span class="token-name">{{ token.name }}</span>
                        </h6>
                        <div class="d-flex justify-content-between mt-3">
                            <div>
                                <small class="text-muted">Balance</small>
                                <p class="mb-0">{{ token.balance|round(4) }}</p>
                            </div>
                            <div>
                                <small class="text-muted">USD Value</small>
                                <p class="mb-0">${{ token.usd_value|round(2) }}</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">Chain</small>
                            <p class="mb-0 small">{{ token.chain }}</p>
                        </div>
                        <div class="mt-1">
                            <small class="text-muted">Wallet</small>
                            <p class="mb-0 small">{{ token.wallet_address[:10] }}...</p>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                        <button class="btn btn-sm btn-outline-primary view-token-details-btn" data-token-id="{{ token.id }}">
                            <i class="fas fa-chart-line me-1"></i> Details
                        </button>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-secondary view-transactions-btn" data-token-id="{{ token.id }}">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <a href="{{ chain_info[token.chain].explorer_url }}/token/{{ token.address }}" 
                               target="_blank" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12 text-center py-5">
                <i class="fas fa-coins fa-3x text-muted mb-3"></i>
                <h5>No tokens found</h5>
                <p class="text-muted">Scan for tokens or add them manually to get started</p>
                <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#scanTokensModal">
                    <i class="fas fa-search me-2"></i> Scan for Tokens
                </button>
            </div>
            {% endfor %}
        </div>
        
        <!-- List View (initially hidden) -->
        <div class="table-responsive" id="tokensList" style="display: none;">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Token</th>
                        <th>Chain</th>
                        <th>Wallet</th>
                        <th>Balance</th>
                        <th>Price</th>
                        <th>24h Change</th>
                        <th>USD Value</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for token in tokens %}
                    <tr class="token-item" data-chain="{{ token.chain }}" data-wallet="{{ token.wallet_id }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="{{ token.logo_url or url_for('static', filename='img/tokens/default.jpeg') }}" 
                                     onerror="this.src='{{ url_for('static', filename='img/tokens/default.jpeg') }}';"
                                     alt="{{ token.symbol }}" class="me-2" width="24" height="24" />
                                <div>
                                    <div>{{ token.symbol }}</div>
                                    <small class="text-muted">{{ token.name }}</small>
                                </div>
                            </div>
                        </td>
                        <td>{{ token.chain }}</td>
                        <td class="text-truncate" style="max-width: 150px;">{{ token.wallet_address[:10] }}...</td>
                        <td>{{ token.balance|round(4) }}</td>
                        <td>${{ token.current_price|round(4) }}</td>
                        <td>
                            <span class="badge {% if token.price_24h_change > 0 %}bg-success{% elif token.price_24h_change < 0 %}bg-danger{% else %}bg-secondary{% endif %}">
                                {% if token.price_24h_change > 0 %}+{% endif %}{{ token.price_24h_change|round(2) }}%
                            </span>
                        </td>
                        <td>${{ token.usd_value|round(2) }}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary view-token-details-btn" data-token-id="{{ token.id }}">
                                    <i class="fas fa-chart-line"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary view-transactions-btn" data-token-id="{{ token.id }}">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                <a href="{{ chain_info[token.chain].explorer_url }}/token/{{ token.address }}" 
                                   target="_blank" class="btn btn-sm btn-outline-info">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <i class="fas fa-coins fa-2x text-muted mb-3"></i>
                            <h5>No tokens found</h5>
                            <p class="text-muted">Scan for tokens or add them manually to get started</p>
                            <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#scanTokensModal">
                                <i class="fas fa-search me-2"></i> Scan for Tokens
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Scan Tokens Modal -->
<div class="modal fade" id="scanTokensModal" tabindex="-1" aria-labelledby="scanTokensModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scanTokensModalLabel">Scan for Tokens</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Select a wallet to scan for tokens:</p>
                <form id="scan-tokens-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                    
                    <div class="mb-3">
                        <label class="form-label">Wallet</label>
                        <select class="form-select" id="scan-wallet-id" name="wallet_id" required>
                            <option value="" selected disabled>Choose a wallet...</option>
                            {% for wallet in wallets %}
                            <option value="{{ wallet.id }}">{{ wallet.address[:10] }}... ({{ wallet.chain }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="include-token-lists" name="include_token_lists" checked>
                        <label class="form-check-label" for="include-token-lists">
                            Include known tokens from token lists
                        </label>
                    </div>
                </form>
                
                <div id="scan-progress" style="display: none;">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="scan-status">Initializing scan...</p>
                </div>
                
                <div id="scan-results" style="display: none;">
                    <h6>Scan Results:</h6>
                    <ul class="list-group" id="discovered-tokens-list">
                        <!-- Discovered tokens will be added here -->
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="start-scan-btn">Start Scan</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Custom Token Modal -->
<div class="modal fade" id="addTokenModal" tabindex="-1" aria-labelledby="addTokenModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTokenModalLabel">Add Custom Token</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="add-token-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                    
                    <div class="mb-3">
                        <label class="form-label">Wallet</label>
                        <select class="form-select" id="add-token-wallet-id" name="wallet_id" required>
                            <option value="" selected disabled>Choose a wallet...</option>
                            {% for wallet in wallets %}
                            <option value="{{ wallet.id }}">{{ wallet.address[:10] }}... ({{ wallet.chain }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Token Address</label>
                        <input type="text" class="form-control" id="token-address" name="token_address" placeholder="0x..." required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Token Symbol (Optional)</label>
                        <input type="text" class="form-control" id="token-symbol" name="symbol" placeholder="e.g. USDT">
                        <div class="form-text">Leave blank to fetch automatically</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Token Name (Optional)</label>
                        <input type="text" class="form-control" id="token-name" name="name" placeholder="e.g. Tether USD">
                        <div class="form-text">Leave blank to fetch automatically</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Decimals (Optional)</label>
                        <input type="number" class="form-control" id="token-decimals" name="decimals" placeholder="e.g. 18">
                        <div class="form-text">Leave blank to fetch automatically</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="add-token-btn">Add Token</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Token List Modal -->
<div class="modal fade" id="importTokenListModal" tabindex="-1" aria-labelledby="importTokenListModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importTokenListModalLabel">Import Token List</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="import-token-list-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                    
                    <div class="mb-3">
                        <label class="form-label">Token List Name</label>
                        <input type="text" class="form-control" id="token-list-name" name="name" placeholder="e.g. Uniswap V2 Tokens" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Token List URL</label>
                        <input type="url" class="form-control" id="token-list-url" name="url" placeholder="https://..." required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Chain</label>
                        <select class="form-select" id="token-list-chain" name="chain" required>
                            <option value="" selected disabled>Choose a chain...</option>
                            {% for chain in chains %}
                            <option value="{{ chain.name }}">{{ chain.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="import-token-list-btn">Import List</button>
            </div>
        </div>
    </div>
</div>

<!-- Token Details Modal -->
<div class="modal fade" id="tokenDetailsModal" tabindex="-1" aria-labelledby="tokenDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tokenDetailsModalLabel">Token Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center">
                        <img id="token-detail-icon" src="{{ url_for('static', filename='img/tokens/default.jpeg') }}" 
                             alt="Token" class="me-2" width="32" height="32">
                        <div>
                            <h5 id="token-detail-symbol" class="mb-0">TOKEN</h5>
                            <div id="token-detail-name" class="text-muted">Token Name</div>
                        </div>
                    </div>
                    <div class="text-end">
                        <h5 id="token-detail-price" class="mb-0">$0.00</h5>
                        <span id="token-detail-change" class="badge bg-secondary">0.00%</span>
                    </div>
                </div>
                
                <hr>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Token Info</h6>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td>Address</td>
                                            <td id="token-detail-address">0x...</td>
                                        </tr>
                                        <tr>
                                            <td>Chain</td>
                                            <td id="token-detail-chain">Chain</td>
                                        </tr>
                                        <tr>
                                            <td>Wallet</td>
                                            <td id="token-detail-wallet">0x...</td>
                                        </tr>
                                        <tr>
                                            <td>Decimals</td>
                                            <td id="token-detail-decimals">18</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Balance Info</h6>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td>Balance</td>
                                            <td id="token-detail-balance">0.00</td>
                                        </tr>
                                        <tr>
                                            <td>USD Value</td>
                                            <td id="token-detail-usd-value">$0.00</td>
                                        </tr>
                                        <tr>
                                            <td>Last Updated</td>
                                            <td id="token-detail-last-updated">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">Price History</h6>
                        <canvas id="price-history-chart" height="200"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Recent Transactions</h6>
                        <div class="table-responsive">
                            <table class="table table-sm" id="token-transactions-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>From/To</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="token-transactions-body">
                                    <tr>
                                        <td colspan="5" class="text-center">Loading transactions...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="sync-token-transactions-btn">
                    <i class="fas fa-sync-alt me-1"></i> Sync Transactions
                </button>
                <a href="#" id="token-explorer-link" target="_blank" class="btn btn-info">
                    <i class="fas fa-external-link-alt me-1"></i> View on Explorer
                </a>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Transactions Modal -->
<div class="modal fade" id="transactionsModal" tabindex="-1" aria-labelledby="transactionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionsModalLabel">Token Transactions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-3">
                    <div>
                        <h6 class="mb-0" id="transactions-token-info">Token: <span id="transactions-token-symbol"></span></h6>
                        <small class="text-muted">Wallet: <span id="transactions-wallet-address"></span></small>
                    </div>
                    <div class="d-flex">
                        <div class="input-group me-2">
                            <span class="input-group-text">Type</span>
                            <select class="form-select" id="tx-type-filter">
                                <option value="all">All</option>
                                <option value="send">Send</option>
                                <option value="receive">Receive</option>
                            </select>
                        </div>
                        <div class="input-group me-2">
                            <span class="input-group-text">Date</span>
                            <input type="date" class="form-control" id="tx-start-date">
                            <input type="date" class="form-control" id="tx-end-date">
                        </div>
                        <button class="btn btn-outline-primary" id="apply-tx-filters">
                            <i class="fas fa-filter"></i> Apply
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table" id="transactions-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Gas</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-list">
                            <tr>
                                <td colspan="8" class="text-center">Loading transactions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <nav aria-label="Transaction pagination">
                    <ul class="pagination justify-content-center" id="transaction-pagination">
                        <!-- Pagination will be dynamically generated -->
                    </ul>
                </nav>
                
                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-info" id="sync-transactions-btn">
                        <i class="fas fa-sync-alt me-1"></i> Sync Transactions
                    </button>
                    <div>
                        <button class="btn btn-secondary" id="export-csv-btn">
                            <i class="fas fa-file-csv me-1"></i> Export CSV
                        </button>
                        <button class="btn btn-secondary" id="export-pdf-btn">
                            <i class="fas fa-file-pdf me-1"></i> Export PDF
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Gas Analytics Modal -->
<div class="modal fade" id="gasAnalyticsModal" tabindex="-1" aria-labelledby="gasAnalyticsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="gasAnalyticsModalLabel">Gas Usage Analytics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-3">
                    <div>
                        <h6 class="mb-0" id="gas-wallet-info">Wallet: <span id="gas-wallet-address"></span></h6>
                        <small class="text-muted">Chain: <span id="gas-wallet-chain"></span></small>
                    </div>
                    <div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-primary btn-sm gas-period-btn active" data-period="30d">30 Days</button>
                            <button type="button" class="btn btn-outline-primary btn-sm gas-period-btn" data-period="7d">7 Days</button>
                            <button type="button" class="btn btn-outline-primary btn-sm gas-period-btn" data-period="24h">24 Hours</button>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Total Gas Used</h6>
                                <h3 id="total-gas-used">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Gas Cost (ETH)</h6>
                                <h3 id="total-gas-cost-eth">0.00</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Gas Cost (USD)</h6>
                                <h3 id="total-gas-cost-usd">$0.00</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Avg Gas (Gwei)</h6>
                                <h3 id="avg-gas-price">0.00</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">Gas Price Over Time</h6>
                        <canvas id="gas-price-chart" height="200"></canvas>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Gas Usage by Token</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm" id="gas-by-token-table">
                                        <thead>
                                            <tr>
                                                <th>Token</th>
                                                <th>Tx Count</th>
                                                <th>Gas Used</th>
                                                <th>Gas Cost</th>
                                            </tr>
                                        </thead>
                                        <tbody id="gas-by-token-body">
                                            <tr>
                                                <td colspan="4" class="text-center">Loading data...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Optimization Suggestions</h6>
                                <ul class="list-group" id="optimization-suggestions">
                                    <li class="list-group-item">Loading suggestions...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Pattern Modal -->
<div class="modal fade" id="transactionPatternModal" tabindex="-1" aria-labelledby="transactionPatternModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionPatternModalLabel">Transaction Pattern Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-3">
                    <div>
                        <h6 class="mb-0" id="pattern-wallet-info">Wallet: <span id="pattern-wallet-address"></span></h6>
                        <small class="text-muted">Total Transactions: <span id="pattern-total-transactions">0</span></small>
                    </div>
                    <div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-primary btn-sm pattern-period-btn active" data-period="all">All Time</button>
                            <button type="button" class="btn btn-outline-primary btn-sm pattern-period-btn" data-period="30d">30 Days</button>
                            <button type="button" class="btn btn-outline-primary btn-sm pattern-period-btn" data-period="7d">7 Days</button>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Activity by Day</h6>
                                <canvas id="activity-by-day-chart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Activity by Hour</h6>
                                <canvas id="activity-by-hour-chart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Transaction Types</h6>
                                <canvas id="transaction-types-chart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Frequent Interactions</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm" id="frequent-interactions-table">
                                        <thead>
                                            <tr>
                                                <th>Address</th>
                                                <th>Sent</th>
                                                <th>Received</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="frequent-interactions-body">
                                            <tr>
                                                <td colspan="4" class="text-center">Loading data...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-body">
                        <h6 class="card-title">Recurring Patterns</h6>
                        <ul class="list-group" id="recurring-patterns">
                            <li class="list-group-item">Loading patterns...</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirm-modal-content">
                Are you sure you want to proceed with this action?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-action-btn">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="{{ url_for('static', filename='js/token-discovery.js') }}"></script>
{% endblock %}
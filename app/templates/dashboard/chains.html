{% extends "base.html" %}

{% block title %}Chains - PME-X{% endblock %}

{% block header %}Chain Management{% endblock %}

{% block content %}
<!-- Chain Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Total Chains</h6>
                        <h3 class="mb-0">{{ chains|length }}</h3>
                    </div>
                    <i class="fas fa-link fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Active</h6>
                        <h3 class="mb-0">{{ chains|selectattr('status', 'equalto', 'active')|list|length }}</h3>
                    </div>
                    <i class="fas fa-check-circle fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Congested</h6>
                        <h3 class="mb-0">{{ chains|selectattr('status', 'equalto', 'congested')|list|length }}</h3>
                    </div>
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-secondary text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Inactive</h6>
                        <h3 class="mb-0">{{ chains|selectattr('status', 'equalto', 'inactive')|list|length }}</h3>
                    </div>
                    <i class="fas fa-power-off fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chain List -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Chain List</h5>
        <div>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#refreshChainModal">
                <i class="fas fa-sync"></i> Refresh Gas Prices
            </button>
            <button class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#addChainModal">
                <i class="fas fa-plus"></i> Add Chain
            </button>
        </div>
    </div>
    <div class="card-body">
        {% if chains %}
        <div class="table-responsive">
            <table class="table table-hover" id="chain-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Chain ID</th>
                        <th>Currency</th>
                        <th>Gas Price (GWEI)</th>
                        <th>Confirm Time</th>
                        <th>Status</th>
                        <th>Tatum Tier</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for chain in chains %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="{{ url_for('static', filename='img/chains/' ~ chain.name ~ '.png') }}" 
                                     onerror="this.src='{{ url_for('static', filename='img/chains/default.jpeg') }}';"
                                     alt="{{ chain.name }}" class="me-2" width="24" height="24" />
                                <span>{{ chain.name }}</span>
                            </div>
                        </td>
                        <td>{{ chain.chain_id }}</td>
                        <td>{{ chain.currency_symbol }}</td>
                        <td>{{ chain.avg_gas_price }}</td>
                        <td>{{ chain.avg_confirmation_time }} sec</td>
                        <td>
                            {% if chain.status == 'active' %}
                            <span class="badge bg-success">Active</span>
                            {% elif chain.status == 'congested' %}
                            <span class="badge bg-warning">Congested</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge {% if chain.tatum_tier == 1 %}bg-info{% elif chain.tatum_tier == 2 %}bg-primary{% else %}bg-secondary{% endif %}">
                                Tier {{ chain.tatum_tier }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary chain-details-btn" data-chain-id="{{ chain.id }}">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary chain-edit-btn" 
                                        data-chain-id="{{ chain.id }}" 
                                        data-name="{{ chain.name }}"
                                        data-chain-id-value="{{ chain.chain_id }}"
                                        data-currency="{{ chain.currency_symbol }}"
                                        data-rpc-url="{{ chain.rpc_url }}"
                                        data-explorer-url="{{ chain.explorer_url }}"
                                        data-tatum-network="{{ chain.tatum_network }}"
                                        data-tatum-tier="{{ chain.tatum_tier }}"
                                        data-status="{{ chain.status }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning chain-status-btn" data-chain-id="{{ chain.id }}">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                <a href="{{ url_for('dashboard.trade_logs') }}?chain={{ chain.name }}" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-history"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            No chains found. Click "Add Chain" to add your first chain.
        </div>
        {% endif %}
    </div>
</div>

<!-- Chain Details Modal -->
<div class="modal fade" id="chainDetailsModal" tabindex="-1" aria-labelledby="chainDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chainDetailsModalLabel">Chain Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row" id="chain-details-content">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" id="detail-name" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Chain ID</label>
                            <input type="text" class="form-control" id="detail-chain-id" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Currency Symbol</label>
                            <input type="text" class="form-control" id="detail-currency" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tatum Network</label>
                            <input type="text" class="form-control" id="detail-tatum-network" readonly>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">RPC URL</label>
                            <input type="text" class="form-control" id="detail-rpc-url" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Explorer URL</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="detail-explorer-url" readonly>
                                <a class="btn btn-outline-secondary" id="explorer-link" href="#" target="_blank">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Last Updated</label>
                            <input type="text" class="form-control" id="detail-last-updated" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <input type="text" class="form-control" id="detail-status" readonly>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Gas History</h6>
                        <canvas id="gas-chart" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="edit-chain-btn">Edit</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Chain Modal -->
<div class="modal fade" id="editChainModal" tabindex="-1" aria-labelledby="editChainModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editChainModalLabel">Edit Chain</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-chain-form" method="POST" action="{{ url_for('dashboard.update_chain') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                    <input type="hidden" id="edit-chain-id-hidden" name="id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" id="edit-name" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Chain ID</label>
                                <input type="number" class="form-control" id="edit-chain-id" name="chain_id" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Currency Symbol</label>
                                <input type="text" class="form-control" id="edit-currency" name="currency_symbol" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tatum Network</label>
                                <input type="text" class="form-control" id="edit-tatum-network" name="tatum_network" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">RPC URL</label>
                                <input type="text" class="form-control" id="edit-rpc-url" name="rpc_url" required>
                                <div class="form-text">Use format: https://chainname.tatum.io/</div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="update-tatum-rpc-btn">
                                        <i class="fas fa-sync"></i> Update to Tatum Format
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Explorer URL</label>
                                <input type="text" class="form-control" id="edit-explorer-url" name="explorer_url">
                                <div class="form-text">Example: https://chainname.etherscan.io</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tatum Tier</label>
                                <select class="form-select" id="edit-tatum-tier" name="tatum_tier" required>
                                    <option value="1">Tier 1</option>
                                    <option value="2">Tier 2</option>
                                    <option value="3">Tier 3</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="edit-status" name="status" required>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="congested">Congested</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-edit-chain-btn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Change Status Modal -->
<div class="modal fade" id="changeStatusModal" tabindex="-1" aria-labelledby="changeStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeStatusModalLabel">Change Chain Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="change-status-form" method="POST" action="{{ url_for('dashboard.update_chain_status') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                    <input type="hidden" id="status-chain-id" name="chain_id">
                    
                    <div class="mb-3">
                        <label class="form-label">Chain</label>
                        <input type="text" class="form-control" id="status-chain-name" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="status-select" name="status" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="congested">Congested</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Reason (Optional)</label>
                        <textarea class="form-control" id="status-reason" name="reason" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-status-btn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Refresh Gas Prices Modal -->
<div class="modal fade" id="refreshChainModal" tabindex="-1" aria-labelledby="refreshChainModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="refreshChainModalLabel">Refresh Gas Prices</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>This will refresh gas prices and status information for all chains.</p>
                <form id="refresh-chains-form" method="POST" action="{{ url_for('dashboard.refresh_gas_prices') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                    
                    <div class="mb-3">
                        <label class="form-label">Select Chains</label>
                        <select class="form-select" id="refresh-chains-select" name="chains" multiple size="8">
                            <option value="all" selected>All Chains</option>
                            {% for chain in chains %}
                            <option value="{{ chain.name }}">{{ chain.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Hold Ctrl/Cmd to select multiple chains</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="refresh-chains-btn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Chain Modal -->
<div class="modal fade" id="addChainModal" tabindex="-1" aria-labelledby="addChainModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addChainModalLabel">Add New Chain</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="add-chain-form" method="POST" action="{{ url_for('dashboard.add_chain') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" id="add-name" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Chain ID</label>
                                <input type="number" class="form-control" id="add-chain-id" name="chain_id" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Currency Symbol</label>
                                <input type="text" class="form-control" id="add-currency" name="currency_symbol" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tatum Network</label>
                                <input type="text" class="form-control" id="add-tatum-network" name="tatum_network" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">RPC URL</label>
                                <input type="text" class="form-control" id="add-rpc-url" name="rpc_url" required>
                                <div class="form-text">Recommended format: https://chainname.tatum.io/</div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="add-tatum-rpc-btn">
                                        <i class="fas fa-sync"></i> Set to Tatum Format
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Explorer URL</label>
                                <input type="text" class="form-control" id="add-explorer-url" name="explorer_url">
                                <div class="form-text">Example: https://chainname.etherscan.io</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tatum Tier</label>
                                <select class="form-select" id="add-tatum-tier" name="tatum_tier" required>
                                    <option value="1">Tier 1</option>
                                    <option value="2">Tier 2</option>
                                    <option value="3">Tier 3</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="add-status" name="status" required>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="add-chain-btn">Add Chain</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chain details modal
    const chainDetailsButtons = document.querySelectorAll('.chain-details-btn');
    const chainDetailsModal = document.getElementById('chainDetailsModal');
    const detailsModal = new bootstrap.Modal(chainDetailsModal);
    let gasChart = null;
    
    chainDetailsButtons.forEach(button => {
        button.addEventListener('click', function() {
            const chainId = this.getAttribute('data-chain-id');
            fetchChainDetails(chainId);
        });
    });
    
    function fetchChainDetails(chainId) {
        // Fetch chain details from API
        fetch(`/api/chain/${chainId}`)
            .then(response => response.json())
            .then(chain => {
                // Populate modal with chain data
                document.getElementById('detail-name').value = chain.name;
                document.getElementById('detail-chain-id').value = chain.chain_id;
                document.getElementById('detail-currency').value = chain.currency_symbol;
                document.getElementById('detail-rpc-url').value = chain.rpc_url;
                document.getElementById('detail-explorer-url').value = chain.explorer_url;
                document.getElementById('explorer-link').href = chain.explorer_url;
                document.getElementById('detail-tatum-network').value = chain.tatum_network;
                document.getElementById('detail-status').value = chain.status.charAt(0).toUpperCase() + chain.status.slice(1);
                document.getElementById('detail-last-updated').value = new Date(chain.last_updated).toLocaleString();
                
                // Initialize or update gas price chart
                fetchGasHistory(chainId, chain.name);
                
                detailsModal.show();
            })
            .catch(error => {
                console.error('Error fetching chain details:', error);
                alert('Error fetching chain details. Please try again.');
            });
    }
    
    function fetchGasHistory(chainId, chainName) {
        // Fetch gas history from API
        fetch(`/api/chain_gas_history/${chainId}`)
            .then(response => response.json())
            .then(gasHistory => {
                updateGasChart(chainName, gasHistory);
            })
            .catch(error => {
                console.error('Error fetching gas history:', error);
                // Create chart with empty data
                updateGasChart(chainName, []);
            });
    }
    
    function updateGasChart(chainName, gasHistory) {
        const ctx = document.getElementById('gas-chart').getContext('2d');
        
        // Destroy previous chart if exists
        if (gasChart) {
            gasChart.destroy();
        }
        
        // Prepare data for chart
        const dates = gasHistory.map(entry => entry.date);
        const gasPrices = gasHistory.map(entry => entry.gas_price);
        
        // Create chart
        gasChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Gas Price (GWEI)',
                    data: gasPrices,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Gas Price (GWEI)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            }
        });
    }
    
    // Edit Chain Modal
    const chainEditButtons = document.querySelectorAll('.chain-edit-btn');
    const editChainModal = document.getElementById('editChainModal');
    const editModal = new bootstrap.Modal(editChainModal);
    
    chainEditButtons.forEach(button => {
        button.addEventListener('click', function() {
            const chainId = this.getAttribute('data-chain-id');
            const name = this.getAttribute('data-name');
            const chainIdValue = this.getAttribute('data-chain-id-value');
            const currency = this.getAttribute('data-currency');
            const rpcUrl = this.getAttribute('data-rpc-url') || `https://${name}.tatum.io/`;
            const explorerUrl = this.getAttribute('data-explorer-url') || `https://${name}scan.io`;
            const tatumNetwork = this.getAttribute('data-tatum-network') || `${name}-mainnet`;
            const tatumTier = this.getAttribute('data-tatum-tier') || '1';
            const status = this.getAttribute('data-status') || 'active';
            
            // Populate edit form
            document.getElementById('edit-chain-id-hidden').value = chainId;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-chain-id').value = chainIdValue;
            document.getElementById('edit-currency').value = currency;
            document.getElementById('edit-rpc-url').value = rpcUrl;
            document.getElementById('edit-explorer-url').value = explorerUrl;
            document.getElementById('edit-tatum-network').value = tatumNetwork;
            document.getElementById('edit-tatum-tier').value = tatumTier;
            document.getElementById('edit-status').value = status;
            
            // Show modal
            editModal.show();
        });
    });
    
    // Save edited chain
    document.getElementById('save-edit-chain-btn').addEventListener('click', function() {
        const form = document.getElementById('edit-chain-form');
        
        // Simple validation
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            return;
        }
        
        // Submit the form to the server
        form.submit();
    });
    
    // Update RPC URL to Tatum format button (edit modal)
    document.getElementById('update-tatum-rpc-btn').addEventListener('click', function() {
        const chainName = document.getElementById('edit-name').value.toLowerCase();
        if (chainName) {
            document.getElementById('edit-rpc-url').value = `https://${chainName}.tatum.io/`;
        } else {
            alert('Please enter a chain name first');
        }
    });
    
    // Update RPC URL to Tatum format button (add modal)
    document.getElementById('add-tatum-rpc-btn').addEventListener('click', function() {
        const chainName = document.getElementById('add-name').value.toLowerCase();
        if (chainName) {
            document.getElementById('add-rpc-url').value = `https://${chainName}.tatum.io/`;
        } else {
            alert('Please enter a chain name first');
        }
    });
    
    // Edit button in details modal
    document.getElementById('edit-chain-btn').addEventListener('click', function() {
        // Find the chain edit button for this chain
        const chainName = document.getElementById('detail-name').value;
        const chainRow = Array.from(document.querySelectorAll('#chain-table tbody tr')).find(row => 
            row.querySelector('td:first-child span').textContent === chainName
        );
        
        if (chainRow) {
            const editButton = chainRow.querySelector('.chain-edit-btn');
            // Hide details modal
            detailsModal.hide();
            // Click the edit button
            setTimeout(() => {
                editButton.click();
            }, 500);
        }
    });
    
    // Change status modal
    const chainStatusButtons = document.querySelectorAll('.chain-status-btn');
    const changeStatusModal = document.getElementById('changeStatusModal');
    const statusModal = new bootstrap.Modal(changeStatusModal);
    
    chainStatusButtons.forEach(button => {
        button.addEventListener('click', function() {
            const chainId = this.getAttribute('data-chain-id');
            const chainRow = document.querySelector(`[data-chain-id="${chainId}"]`).closest('tr');
            const chainName = chainRow.querySelector('td:first-child span').textContent;
            const statusElement = chainRow.querySelector('td:nth-child(6) span');
            const currentStatus = statusElement.textContent.toLowerCase();
            
            document.getElementById('status-chain-id').value = chainId;
            document.getElementById('status-chain-name').value = chainName;
            document.getElementById('status-select').value = currentStatus === 'active' ? 'active' : 
                                                           currentStatus === 'congested' ? 'congested' : 'inactive';
            
            statusModal.show();
        });
    });
    
    // Save status changes
    document.getElementById('save-status-btn').addEventListener('click', function() {
        const form = document.getElementById('change-status-form');
        
        // Submit the form to update status in database
        form.submit();
    });
    
    // Refresh chains button
    document.getElementById('refresh-chains-btn').addEventListener('click', function() {
        const form = document.getElementById('refresh-chains-form');
        
        // Submit the form to refresh gas prices
        form.submit();
    });
    
    // Add chain button
    document.getElementById('add-chain-btn').addEventListener('click', function() {
        const form = document.getElementById('add-chain-form');
        
        // Simple validation
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            return;
        }
        
        // Submit the form to add a new chain
        form.submit();
    });
    
    // Make the chain table sortable
    document.querySelectorAll('#chain-table th').forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
            const table = document.getElementById('chain-table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const index = Array.from(header.parentNode.children).indexOf(header);
            
            const direction = header.classList.contains('asc') ? -1 : 1;
            
            // Update header classes
            document.querySelectorAll('#chain-table th').forEach(th => {
                th.classList.remove('asc', 'desc');
            });
            
            header.classList.add(direction === 1 ? 'asc' : 'desc');
            
            // Sort rows
            rows.sort((a, b) => {
                const aValue = a.querySelectorAll('td')[index].textContent.trim();
                const bValue = b.querySelectorAll('td')[index].textContent.trim();
                
                if (!isNaN(parseFloat(aValue)) && !isNaN(parseFloat(bValue))) {
                    return direction * (parseFloat(aValue) - parseFloat(bValue));
                } else {
                    return direction * aValue.localeCompare(bValue);
                }
            });
            
            // Remove existing rows
            rows.forEach(row => tbody.removeChild(row));
            
            // Add sorted rows
            rows.forEach(row => tbody.appendChild(row));
        });
    });
});
</script>
{% endblock %} 
 The code above is the HTML template for the chains page. It includes the chain details modal, edit chain modal, change status modal, refresh gas prices modal, and add chain modal. It also includes JavaScript code to handle the modals and make the chain table sortable. 
 The JavaScript code fetches chain details, gas history, and updates the gas price chart when a chain is selected. It also handles the edit chain modal, change status modal, and add chain modal. 
 The  fetchChainDetails  function fetches chain details from the API and populates the chain details modal with the data. The  fetchGasHistory  function fetches gas history for a chain and updates the gas price chart. The  updateGasChart  function creates or updates the gas price chart with the fetched data. 
 The edit chain modal is shown when the edit button is clicked, and the form data is populated with the chain details. The  save-edit-chain-btn  event listener submits the form to update the chain details. The  update-tatum-rpc-btn  and  add-tatum-rpc-btn  event listeners update the RPC URL to the Tatum format. 
 The change status modal is shown when the change status button is clicked, and the form data is populated with the chain details. The  save-status-btn  event listener submits the form to update the chain status. 
 The refresh chains button fetches gas prices for all chains when clicked. The  refresh-chains-btn  event listener submits the form to refresh gas prices. 
 The add chain modal is shown when the add chain button is clicked, and the form data is validated before submission. The  add-chain-btn  event listener submits the form to add a new chain. 
 The chain table is made sortable by clicking on the table headers. The  click  event listener sorts the rows based on the clicked header and direction. 
 Conclusion 
 In this tutorial, we built a cryptocurrency dashboard using Python, Flask, and SQLite. We created a web application to manage cryptocurrency chains, view gas prices, and update chain details. We used Flask to create the backend API and Jinja templates to render the frontend views. 
 We implemented features to add, edit, and delete chains, view gas prices, and update chain status. We used SQLite to store chain data and gas prices and used Chart.js to display gas price history. 
 You can extend this project by adding more features
to manage gas prices, view historical data, and analyze trends. You can also
integrate with external APIs to fetch real-time data and display more
information about cryptocurrency chains. 
 To learn more about Flask, check out our  Flask topic page for tutorials and articles. 
 To learn more about web development, check out our  Web Development topic page for tutorials and articles. 
 To learn more about Python, check out our  Python topic page for tutorials and articles. 
 To learn more about databases, check out our  Databases topic page for tutorials and articles. 
 To learn more about web development tools, check out our  Web Development Tools topic page for tutorials and articles. 
 To learn more about JavaScript, check out our  JavaScript topic page for tutorials and articles. 
 To learn more about Chart.js, check out the  Chart.js documentation for examples and documentation. 
 To learn more about SQLite, check out the  SQLite documentation for examples and documentation. 
 To learn more about APIs, check out the  APIs topic page for tutorials and articles. 
 To learn more about cryptocurrency, check out the  Cryptocurrency topic page for tutorials and articles. 
 To learn more about blockchain, check out the  Blockchain topic page for tutorials and articles. 
 To learn more about Ethereum, check out the  Ethereum documentation for examples and documentation. 
 To learn more about Tatum, check out the  Tatum documentation for examples and documentation. 
 To learn more about Bootstrap, check out the  Bootstrap documentation for examples and documentation. 
 To learn more about HTML, check out the  HTML topic page for tutorials and articles. 
 To learn more about CSS, check out the  CSS topic page for tutorials and articles. 
 To learn more about Jinja, check out the  Jinja documentation for examples and documentation. 
 To learn more about web development best practices, check out our  Web Development Best Practices topic page for tutorials and articles. 
 To learn more about software development, check out our  Software Development topic page for tutorials and articles. 
 To learn more about full-stack development, check out our  Full-Stack Development topic page for tutorials and articles. 
 To learn more about building web applications, check out our  Web Applications topic page for tutorials and articles. 
 To learn more about building APIs, check out our  APIs topic page for tutorials and articles. 
 To learn more about building databases, check out our  Databases topic page for tutorials and articles. 
 To learn more about building dashboards, check out our  Dashboards topic page for tutorials and articles. 
 To learn more about building CRUD applicationshttps://ethereum-mainnet.gateway.tatum.io/v3/ethereum/mainnet/info, check out our  CRUD Applications topic page for tutorials and articles.